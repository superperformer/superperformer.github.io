<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
    </script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"
    integrity="sha512-zlWWyZq71UMApAjih4WkaRpikgY9Bz1oXIW5G0fED4vk14JjGlQ1UmkGM392jEULP8jbNMiwLWdM8Z87Hu88Fw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css"
    integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script type="text/javascript"
    src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <title>TV Lite</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: black;
    }

    .row>* {
      padding: 0;
    }

    .frame-title {
      z-index: 999;
      padding-left: 11em;
      padding-top: 0.1em;
      height: 20px;
    }

    /*enlarge toast font size*/
    .jq-toast-single {
      font-size: 20px;
    }

    iframe {
      width: 80%; /*leave room for finger to scroll*/
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 col-xl-6 col-xxl-4">
        <div class="ratio ratio-4x3">
          <div class="frame-title">
            <a class="btn btn-lg btn-outline-primary" onclick="evalSymbol('like', this);">&#128077; Like</a>
            <a class="btn btn-lg btn-outline-danger" onclick="evalSymbol('dislike', this);">&#128078; Dislike</a>
            <a class="btn btn-lg btn-outline-warning" onclick="evalSymbol('exclude', this);">&#129529; Exclude</a>
          </div>
          <div class="lite-container"></div>
        </div>
      </div>
      <div class="col-lg-12 col-xl-6 col-xxl-4">
        <div class="ratio ratio-4x3">
          <div class="frame-title">
            <a class="btn btn-lg btn-outline-primary" onclick="evalSymbol('like', this);">&#128077; Like</a>
            <a class="btn btn-lg btn-outline-danger" onclick="evalSymbol('dislike', this);">&#128078; Dislike</a>
            <a class="btn btn-lg btn-outline-warning" onclick="evalSymbol('exclude', this);">&#129529; Exclude</a>
          </div>
          <div class="lite-container"></div>
        </div>
      </div>
      <div class="col-lg-12 col-xl-6 col-xxl-4">
        <div class="ratio ratio-4x3">
          <div class="frame-title">
            <a class="btn btn-lg btn-outline-primary" onclick="evalSymbol('like', this);">&#128077; Like</a>
            <a class="btn btn-lg btn-outline-danger" onclick="evalSymbol('dislike', this);">&#128078; Dislike</a>
            <a class="btn btn-lg btn-outline-warning" onclick="evalSymbol('exclude', this);">&#129529; Exclude</a>
          </div>
          <div class="lite-container"></div>
        </div>
      </div>
      <div class="col-lg-12 col-xl-6 col-xxl-4">
        <div class="ratio ratio-4x3">
          <div class="frame-title">
            <a class="btn btn-lg btn-outline-primary" onclick="evalSymbol('like', this);">&#128077; Like</a>
            <a class="btn btn-lg btn-outline-danger" onclick="evalSymbol('dislike', this);">&#128078; Dislike</a>
            <a class="btn btn-lg btn-outline-warning" onclick="evalSymbol('exclude', this);">&#129529; Exclude</a>
          </div>
          <div class="lite-container"></div>
        </div>
      </div>
      <div class="col-lg-12 col-xl-6 col-xxl-4">
        <div class="ratio ratio-4x3">
          <div class="frame-title">
            <a class="btn btn-lg btn-outline-primary" onclick="evalSymbol('like', this);">&#128077; Like</a>
            <a class="btn btn-lg btn-outline-danger" onclick="evalSymbol('dislike', this);">&#128078; Dislike</a>
            <a class="btn btn-lg btn-outline-warning" onclick="evalSymbol('exclude', this);">&#129529; Exclude</a>
          </div>
          <div class="lite-container"></div>
        </div>
      </div>
      <div class="col-lg-12 col-xl-6 col-xxl-4">
        <div class="ratio ratio-4x3">
          <div class="frame-title">
            <a class="btn btn-lg btn-outline-primary" onclick="evalSymbol('like', this);">&#128077; Like</a>
            <a class="btn btn-lg btn-outline-danger" onclick="evalSymbol('dislike', this);">&#128078; Dislike</a>
            <a class="btn btn-lg btn-outline-warning" onclick="evalSymbol('exclude', this);">&#129529; Exclude</a>
          </div>
          <div class="lite-container"></div>
        </div>
      </div>
    </div>
  </div>
  <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- <a class="navbar-brand" href="#">Watchlist</a> -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
        aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <div class="d-flex">
          <select class="form-select form-select-lg" aria-label=".form-select-lg" id="selWatchlist">
            <option selected value="wedgeToday">Eval Today</option>
            <option value="wedgeAll">Eval All</option>
            <option value="wedgeLiked">Liked All</option>
            <!-- <option value="pocketToday">pocketToday</option>
            <option value="pocketAll">pocketAll</option> -->
          </select>
          <input type="text" class="form-control col-me-8" id="txtNames" value="" />
          <input type="button" class="btn btn-outline-secondary" id="btnPrev" value=" Prev " accesskey="2" />
          <input type="button" class="btn btn-primary" id="btnPaste" value=" Paste " />
          <input type="button" class="btn btn-outline-primary btn-lg" id="btnNext" value="    Next    " accesskey="1" />
          <!-- <input type="button" class="btn btn-outline-primary" id="btnTest" value="Test" accesskey="3"/> -->
          <span class="navbar-text" id="spnCnt" style="width: 150px;text-align: center;"></span>
          </li>
        </div>
      </div>
  </nav>
  <script>
    let lstChart = []; //chart obj
    let lstSeries = []; //arry of series
    let watchId; //watchlistId
    const watchMarket = 'us';//get watchlist from the marekt tw|us
    (function () {
      var idxName = 0;
      var names = {};
      let twIndustry;// = await loadIndustry();
      fetch('https://node-exp.vercel.app/db/tw-industry.json')
        .then((response) => response.json())
        .then((json) => {//console.log(json)
          twIndustry = json;
        });
      //load from query string if any
      const qprm = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
      });
      if (qprm.sym && qprm.sym.length > 0) {
        $("#txtNames").val(qprm.sym);
        console.log(`Loaded from querystring ${qprm.sym}`);
      }
      else //load from localstorage
      {
        const storedNames = localStorage.getItem('watchlist1');
        // console.log(storedNames);
        if (storedNames && storedNames.length > 0) {
          $("#txtNames").val(storedNames);
        }
      }
      //initChart
      $('.lite-container').each(function (idx, el) {
        lstChart.push(initChart(el));
        lstSeries.push([]); //push same numbers of empty array
      });
      $('#btnNext').click(function (e) {
        //scroll to top
        $('html, body').scrollTop(0);
        //get symbols
        if ($.isEmptyObject(names)) {
          names = $("#txtNames").val().toUpperCase().split(",");
          console.log(names);
        }
        if (names && names.length > 0) {
          if (idxName > names.length - 1) {
            showMsg('info', 'End of list');
            return; //no more process
          }
          //keep idxName for max limit
          let idxNameKeep = idxName;
          let hasShownEol = false;//has shown end of list or not
          $('.lite-container').each(function (i, obj) {
            if (idxNameKeep < names.length) {
              setTimeout(() => { //delay seconds to reduce cpu load
                let indu = '';
                //4-digit symbol && check industry before use
                if (names[idxName].match(/^\d{4}$/g) && twIndustry[names[idxName]] && twIndustry[names[idxName]].industry)
                  indu = `${twIndustry[names[idxName]].name}  ${twIndustry[names[idxName]].industry}`;
                $(this).prev().text(names[idxName] + ' ' + indu);
                //save symbol in frame-title for eval
                $(this).prev().data('sym', names[idxName]);
                //load Chart
                loadChart(names[idxName++], lstChart[i], i);
                $("#spnCnt").text(idxName + " / " + names.length);
              }, 1200 * i);
              idxNameKeep++;
            }
            else//end of list
            {
              //$(this).prev().text(''); //clear title
              $(this).prev().data('sym', '');//clear sym
               //clear chart with empty symbol
              loadChart('', lstChart[i], i);
              if (!hasShownEol) {
                showMsg('info', 'End of list');
                hasShownEol = true;
              }
              //no return to continue to clear following charts
              //return false; //no more process, exit .each
            }
          });
        }
      });
      $('#btnPrev').click(function (e) {
        if (idxName > $(".lite-container").length * 2 - 1) {
          //substract idxName
          idxName = idxName - $(".lite-container").length * 2;
          //load by auto click
          $('#btnNext').click();
        }
        else if (idxName > $(".lite-container").length - 1 && idxName <= $(".lite-container").length * 2 - 1) {
          idxName = 0; //set to the first;
          $('#btnNext').click();
        }
        else {
          showMsg('info', 'No previous one');
        }
      });
      $('#txtNames').change(function (e) {
        if ($("#txtNames").val().length >= 4) {
          //reset count
          idxName = 0;
          //reload list
          names = $("#txtNames").val().toUpperCase().replace(/(TWSE:|TPEX:|TPE:|.TWO|.TW|\s)/g,'').split(",");
          //save to localstorage
          localStorage.setItem('watchlist1', $("#txtNames").val());
        }
      });
      async function pasteFromClip(input) {
        const text = await navigator.clipboard.readText();
        if (text && text.length)
          input.val(text);
      }
      $('#btnPaste').click(function (e) {
        pasteFromClip($("#txtNames"));
      });
      //test async
      // async function loadIndustry() {
      //   fetch('./tw-industry.json')
      //     .then((response) => response.json())
      //     .then((json) => {//console.log(json)
      //       return json;
      //     });
      // }
      //AUTO LOAD
      setTimeout(() => { //delay seconds to wait for industry loading
        //$('#btnNext').click();
        $('#selWatchlist').change();
      }, 1000);

      $('#selWatchlist').change(function () {
        //load watchlist to txtNames
        watchId = $('#selWatchlist').val();
        if (watchId) {
          google.script.run.withSuccessHandler(onLoadWatchlist)
            .apiGetWatchlist(watchMarket, watchId);
        }
        else showMsg('error', `watchId: ${watchId}`);
      });
    })();
    function onLoadWatchlist(str) {
      $('#txtNames').val(str);
      if (str && str.length) {
        showMsg('info', `watchlist ${watchId} loaded`);
        //console.log('watchlist loaded');
        //force names change
        $("#txtNames").change();
        $("#btnNext").click();//load chart
      }
      else showMsg('warning', `watchlist ${watchId} is empty`);
    }
    /*act: action; cntl: triggered control*/
    function evalSymbol(act, cntl) {
      const symbol = $(cntl).parent().data('sym');
      //console.log(`watchId: ${watchId} sym: ${symbol} act:${act}`);
      //showMsg('info',`watchId: ${watchId} sym: ${symbol} act:${act}`);
      if (watchId && symbol)
        google.script.run.withSuccessHandler(onSymbolEvalated)
          .apiEvalSymbol(watchMarket, watchId, act, symbol);
      else showMsg('error', `watchId: ${watchId} symbol: ${symbol}`);
    }
    function onSymbolEvalated(prm) {
      showMsg('info', `${prm.symbol} ${prm.msg}`);
    }
    //type: info|warning|success|error
    const showMsg = (type, msg) => {
      let optHeading = 'Information';
      let optIcon = 'info';
      if (type == 'warning') {
        optHeading = 'Warning';
        optIcon = 'warning';
      }
      else if (type == 'error') {
        optHeading = 'Error';
        optIcon = 'error';
      } else if (type == 'success') {
        optHeading = 'Success';
        optIcon = 'success';
      }
      $.toast({
        heading: optHeading,
        text: msg,
        showHideTransition: 'slide',
        icon: optIcon,
        hideAfter: 5000
      });
    };
    //*** input containerId, output chart reference
    function initChart(container) {
      //const container = document.getElementById(containerId);
      // Create the Lightweight Chart within the container element
      const chart = LightweightCharts.createChart(
        container,
        {
          layout: {
            background: { color: "#000000" },
            textColor: "#C3BCDB",
          },
          grid: {
            vertLines: { color: "#1a1a1a" },
            horzLines: { color: "#1a1a1a" },
          },
        }
      );

      // Setting the border color for the vertical axis
      chart.priceScale().applyOptions({
        borderColor: "#71649C",
      });

      // Setting the border color for the horizontal axis
      chart.timeScale().applyOptions({
        borderColor: "#71649C",
      });

      // Adjust the starting bar width (essentially the horizontal zoom)
      chart.timeScale().applyOptions({
        barSpacing: 10,
        rightOffset: 7, //margin space in bars from the right side of the chart
      });
      // Customizing the Crosshair
      chart.applyOptions({
        crosshair: {
          // Change mode from default 'magnet' to 'normal'.
          // Allows the crosshair to move freely without snapping to datapoints
          mode: LightweightCharts.CrosshairMode.Normal,
          // // Vertical crosshair line (showing Date in Label)
          // vertLine: {
          //   width: 8,
          //   color: '#C3BCDB44',
          //   style: LightweightCharts.LineStyle.Solid,
          //   labelBackgroundColor: '#9B7DFF',
          // },

          // // Horizontal crosshair line (showing Price in Label)
          // horzLine: {
          //   color: '#9B7DFF',
          //   labelBackgroundColor: '#9B7DFF',
          // },
        },
      });
      // Adding a window resize event handler to resize the chart when
      // the window size changes.
      // Note: for more advanced examples (when the chart doesn't fill the entire window)
      // you may need to use ResizeObserver -> https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver
      window.addEventListener("resize", () => {
        chart.resize(container.offsetWidth, container.offsetHeight);
      });
      return chart;
    };
    //load symbol data into the chart
    function loadChart(symbol, chart, idx) {
      //set title
      chart.applyOptions({
        watermark: {
          visible: true,
          fontSize: 24,
          horzAlign: "left", //"left" | "center" | "right"
          vertAlign: "top", //"top" | "center" | "bottom"
          color: "rgba(171, 71, 188, 0.5)",
          text: `${symbol}`, // | ${quote.name} | ${quote.industry}`
        },
      });
      //clear chart
      //remove old Series if any
      if (lstSeries[idx] !== undefined) {
        lstSeries[idx].forEach((el) => {
          chart.removeSeries(el);
        });
        //reset
        lstSeries[idx] = [];
      }
      //check symbol format
      if (!symbol.match(/^[0-9A-Za-z]+$/g)) {
        return;
      }
      //use async to await fetching
      (async () => {
        // Generate sample data to use within a candlestick series
        const quote = await fetchQuote(symbol);
        //console.log(`name: ${quote.name} industry ${quote.industry}`);
        const candleStickData = quote.priceSeries;
        const volumeHistData = quote.volumeSeries;
        const volumeSeries = chart.addHistogramSeries({
          color: "#26a69a",
          priceFormat: {
            type: "volume",
          },
          priceScaleId: "", // set as an overlay by setting a blank priceScaleId
          // set the positioning of the volume series
          scaleMargins: {
            top: 0.7, // highest point of the series will be 70% away from the top
            bottom: 0,
          },
          priceLineVisible: false, //hide last volume horizonal line
        });
        volumeSeries.priceScale().applyOptions({
          scaleMargins: {
            top: 0.7, // highest point of the series will be 70% away from the top
            bottom: 0,
          },
        });
        lstSeries[idx].push(volumeSeries); //save series pointer
        // Create the Main Series (Candlesticks)
        const mainSeries = chart.addCandlestickSeries();
        lstSeries[idx].push(mainSeries); //save series pointer
        // Set the data for the Main Series
        mainSeries.setData(candleStickData);
        volumeSeries.setData(volumeHistData);
        //create ma series
        const lineSeriesMa50 = chart.addLineSeries({
          color: "orange",
          priceLineVisible: false,
          lineWidth: 2,
          crosshairMarkerVisible: false,
          lastValueVisible: false,
          // title: 'ma50',
        });
        lineSeriesMa50.setData(calculateSMA(candleStickData, 50));
        const lineSeriesMa21 = chart.addLineSeries({
          color: "gold",
          priceLineVisible: false,
          lineWidth: 1,
          crosshairMarkerVisible: false,
          lastValueVisible: false,
        });
        lineSeriesMa21.setData(calculateSMA(candleStickData, 21));
        const lineSeriesMa10 = chart.addLineSeries({
          color: "gray",
          priceLineVisible: false,
          lineWidth: 1,
          crosshairMarkerVisible: false,
          lastValueVisible: false,
        });
        lineSeriesMa10.setData(calculateSMA(candleStickData, 10));
        const lineSeriesMa5 = chart.addLineSeries({
          color: "darkgray",
          priceLineVisible: false,
          lineWidth: 1,
          crosshairMarkerVisible: false,
          lastValueVisible: false,
        });
        lineSeriesMa5.setData(calculateSMA(candleStickData, 5));
        lstSeries[idx].push(lineSeriesMa50); //save series pointer
        lstSeries[idx].push(lineSeriesMa21);
        lstSeries[idx].push(lineSeriesMa10);
        lstSeries[idx].push(lineSeriesMa5);
      })();//end of async
    }
    async function fetchQuote(symbol) {
      return await fetch(`https://node-exp.vercel.app/about/${symbol}`, {
        // method: 'POST',
        // body: JSON.stringify({id: "200"})
      })
        .then(
          (response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          },
          (networkError) => {
            console.log("network error");
          }
        )
        .catch((err) => {
          console.log(err);
        })
        .then((json) => {
          return json;
        });
      //const response = await fetch("https://node-exp.vercel.app/about/2330");
    }
    function calculateSMA(priceSeries, period) {
      const avg = (priceSeries) => {
        let sum = 0;
        for (let i = 0; i < priceSeries.length; i++) {
          sum += priceSeries[i].close;
        }
        return sum / priceSeries.length;
      };
      const maSeries = [];
      for (let i = period - 1, len = priceSeries.length; i < len; i++) {
        const val = avg(priceSeries.slice(i - period + 1, i));
        maSeries.push({ time: priceSeries[i].time, value: val });
      }
      return maSeries;
    }
  </script>
</body>

</html>